openapi: 3.0.3
info:
  title: Credit Service API
  description: |
    API for managing institution credits, including balance checking, 
    credit addition, usage tracking, and payment processing.
  version: 1.0.0

servers:
  - url: /api/credits
    description: Credit service base path

paths:
  /institution/{institutionId}/balance:
    get:
      summary: Get credit balance
      description: Retrieves the current credit balance for an institution
      parameters:
        - name: institutionId
          in: path
          required: true
          schema:
            type: string
          description: Unique identifier of the institution
      responses:
        '200':
          description: Credit balance retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditBalance'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /institution/{institutionId}/add:
    post:
      summary: Add credits
      description: Adds credits to the institution's account
      parameters:
        - name: institutionId
          in: path
          required: true
          schema:
            type: string
          description: Unique identifier of the institution
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - credits
              properties:
                credits:
                  type: number
                  example: 100
                  minimum: 1
                  description: Amount of credits to add
      responses:
        '200':
          description: Credits added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResult'
        '400':
          description: Invalid credit amount
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /institution/{institutionId}/use:
    post:
      summary: Use credits
      description: Deducts credits from an institution for an operation
      parameters:
        - name: institutionId
          in: path
          required: true
          schema:
            type: string
          description: Unique identifier of the institution
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - credits
                - operation
              properties:
                credits:
                  type: number
                  minimum: 1
                  example: 5
                operation:
                  type: string
                  example: GENERATE_QUIZ
                courseId:
                  type: string
                  example: course123
      responses:
        '200':
          description: Credits used successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditUsageResult'
        '400':
          description: Invalid request or insufficient credits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /institution/{institutionId}/usage:
    get:
      summary: Get credit usage history
      description: Returns the usage logs for an institution
      parameters:
        - name: institutionId
          in: path
          required: true
          schema:
            type: string
          description: Unique identifier of the institution
      responses:
        '200':
          description: Usage history retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CreditUsageLog'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    CreditBalance:
      type: object
      properties:
        institutionId:
          type: string
        totalCredits:
          type: number
        usedCredits:
          type: number
        availableCredits:
          type: number
      example:
        institutionId: inst123
        totalCredits: 500
        usedCredits: 200
        availableCredits: 300

    CreditUsageResult:
      type: object
      properties:
        institutionId:
          type: string
        totalCredits:
          type: number
        usedCredits:
          type: number
        availableCredits:
          type: number
        creditsUsed:
          type: number
      example:
        institutionId: inst123
        totalCredits: 500
        usedCredits: 205
        availableCredits: 295
        creditsUsed: 5

    PaymentResult:
      type: object
      properties:
        transactionId:
          type: string
        institutionId:
          type: string
        numOfCredits:
          type: number
        status:
          type: string
          enum: [PENDING, COMPLETED, FAILED, REFUNDED]
        creditBalance:
          type: number
        reasonForDecline:
          type: string
          nullable: true
      example:
        transactionId: "61234b7a1234567890abcdef"
        institutionId: "inst123"
        numOfCredits: 100
        status: "COMPLETED"
        creditBalance: 350
        reasonForDecline: null

    CreditUsageLog:
      type: object
      properties:
        institutionId:
          type: string
        creditsUsed:
          type: number
        operation:
          type: string
        courseId:
          type: string
          nullable: true
        usedAt:
          type: string
          format: date-time
      example:
        institutionId: inst123
        creditsUsed: 5
        operation: GENERATE_QUIZ
        courseId: course123
        usedAt: "2024-06-15T12:00:00Z"

    Error:
      type: object
      properties:
        message:
          type: string
        error:
          type: string
          nullable: true
      example:
        message: "Failed to get credit balance"
        error: "Database connection timeout"
